# åŸå§‹è¯„è®ºæ›´æ–°æ¨¡å—æ–‡æ¡£

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

åŸå§‹è¯„è®ºæ¨¡å—æ˜¯ç”¨äºæŸ¥è¯¢å’Œç®¡ç†è½¦å‹è¯„è®ºæ•°æ®çš„æ ¸å¿ƒæ¨¡å—ã€‚è¯¥æ¨¡å—å…è®¸å‰ç«¯é€šè¿‡æ¸ é“IDå’Œè½¦å‹æ ‡è¯†æ¥æŸ¥è¯¢æŒ‡å®šè½¦å‹ä¸‹çš„æ‰€æœ‰åŸå§‹è¯„è®ºIDåˆ—è¡¨ã€‚

## ğŸ—ï¸ æ–‡ä»¶ç»“æ„

```
app/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ vehicle_update.py          # è½¦å‹æ›´æ–°ç›¸å…³æ¨¡å‹
â”‚   â””â”€â”€ raw_comment_update.py      # åŸå§‹è¯„è®ºæ›´æ–°æ¨¡å‹ï¼ˆç‹¬ç«‹æ–‡ä»¶ï¼‰
â”œâ”€â”€ schemas/
â”‚   â””â”€â”€ raw_comment_update.py      # åŸå§‹è¯„è®ºæ›´æ–°ç›¸å…³çš„æ•°æ®æ ¡éªŒæ¨¡å¼
â”œâ”€â”€ services/
â”‚   â””â”€â”€ raw_comment_update_service.py  # åŸå§‹è¯„è®ºæ›´æ–°ä¸šåŠ¡é€»è¾‘æœåŠ¡
â””â”€â”€ api/
    â””â”€â”€ endpoints/
        â””â”€â”€ raw_comment_update.py  # åŸå§‹è¯„è®ºæ›´æ–°APIç«¯ç‚¹

# æµ‹è¯•æ–‡ä»¶
test_raw_comment.py                 # æ¨¡å—åŠŸèƒ½æµ‹è¯•è„šæœ¬ï¼ˆå»ºè®®é‡å‘½åä¸ºtest_raw_comment_update.pyï¼‰
test_raw_comment_update_api.py      # APIæ¥å£æµ‹è¯•è„šæœ¬
```

## ğŸ“Š æ•°æ®æ¨¡å‹

### RawComment æ¨¡å‹
- `raw_comment_id`: åŸå§‹è¯„è®ºID (ä¸»é”®)
- `vehicle_channel_id_fk`: å…³è”çš„è½¦å‹æ¸ é“è¯¦æƒ…ID (å¤–é”®)
- `identifier_on_channel`: è¯„è®ºåœ¨æºæ¸ é“ä¸Šçš„ä¸šåŠ¡ID
- `comment_source_url`: è¯„è®ºåœ¨æºæ¸ é“çš„åŸå§‹URL
- `comment_content`: è¯„è®ºåŸå§‹å†…å®¹æ–‡æœ¬
- `posted_at_on_channel`: è¯„è®ºåœ¨æºæ¸ é“çš„å‘å¸ƒæ—¶é—´
- `crawled_at`: è¯„è®ºçˆ¬å–å…¥åº“æ—¶é—´

## ğŸ”„ ä¸šåŠ¡æµç¨‹

1. **å‰ç«¯è¯·æ±‚**: ä¼ å…¥ `channel_id` å’Œ `identifier_on_channel`
2. **æŸ¥è¯¢è½¦å‹**: åœ¨ `vehicle_channel_details` è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è½¦å‹
3. **è·å–è½¦å‹ID**: æå– `vehicle_channel_id`
4. **æŸ¥è¯¢è¯„è®º**: ä½¿ç”¨ `vehicle_channel_id` åœ¨ `raw_comments` è¡¨ä¸­æŸ¥è¯¢æ‰€æœ‰è¯„è®ºID
5. **è¿”å›ç»“æœ**: è¿”å›è½¦å‹ä¿¡æ¯å’Œè¯„è®ºIDåˆ—è¡¨

## ğŸš€ APIæ¥å£

### 1. æŸ¥è¯¢åŸå§‹è¯„è®ºID
- **ç«¯ç‚¹**: `POST /api/raw-comments/query`
- **åŠŸèƒ½**: æ ¹æ®æ¸ é“IDå’Œè½¦å‹æ ‡è¯†æŸ¥è¯¢è¯¥è½¦å‹ä¸‹çš„æ‰€æœ‰åŸå§‹è¯„è®ºID
- **è¯·æ±‚å‚æ•°**:
  ```json
  {
    "channel_id": 1,
    "identifier_on_channel": "s3170"
  }
  ```
- **å“åº”æ•°æ®**:
  ```json
  {
    "vehicle_channel_info": {
      "vehicle_channel_id": 123,
      "channel_id": 1,
      "identifier_on_channel": "s3170",
      "name_on_channel": "å¥¥è¿ªA3",
      "url_on_channel": "https://www.autohome.com.cn/spec/s3170/",
      "temp_brand_name": "å¥¥è¿ª",
      "temp_series_name": "ä¸€æ±½å¥¥è¿ª",
      "temp_model_year": null
    },
    "raw_comment_ids": [1, 2, 3, 4, 5],
    "total_comments": 5
  }
  ```

### 2. è·å–è½¦å‹è¯„è®ºæ•°é‡
- **ç«¯ç‚¹**: `GET /api/raw-comments/vehicle/{channel_id}/{identifier}/count`
- **åŠŸèƒ½**: ç»Ÿè®¡æŒ‡å®šè½¦å‹çš„è¯„è®ºæ•°é‡
- **å“åº”æ•°æ®**:
  ```json
  {
    "channel_id": 1,
    "identifier_on_channel": "s3170",
    "vehicle_channel_id": 123,
    "vehicle_name": "å¥¥è¿ªA3",
    "comment_count": 5
  }
  ```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. ç›´æ¥æµ‹è¯•æ¨¡å—åŠŸèƒ½
```bash
python test_raw_comment.py
```
è¿™ä¸ªè„šæœ¬ä¼šï¼š
- æ£€æŸ¥è½¦å‹æ•°æ®
- æ·»åŠ æµ‹è¯•è¯„è®ºæ•°æ®
- æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½
- æµ‹è¯•å¼‚å¸¸å¤„ç†

### 2. æµ‹è¯•APIæ¥å£
```bash
# å…ˆå¯åŠ¨æœåŠ¡å™¨
python -m uvicorn main:app --reload

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡ŒAPIæµ‹è¯•
python test_raw_comment_update_api.py
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¾èµ–**: éœ€è¦å…ˆæœ‰è½¦å‹æ•°æ®ï¼ˆ`vehicle_channel_details`è¡¨ï¼‰æ‰èƒ½æŸ¥è¯¢è¯„è®º
2. **å¤–é”®çº¦æŸ**: `raw_comments` è¡¨é€šè¿‡ `vehicle_channel_id_fk` å…³è”åˆ° `vehicle_channel_details` è¡¨
3. **å”¯ä¸€æ€§çº¦æŸ**: æ¯ä¸ªè½¦å‹æ¸ é“ä¸‹çš„è¯„è®ºæ ‡è¯†å¿…é¡»å”¯ä¸€
4. **å¼‚å¸¸å¤„ç†**: å½“è½¦å‹ä¸å­˜åœ¨æ—¶ä¼šæŠ›å‡º `ValueError` å¼‚å¸¸å¹¶è¿”å›404çŠ¶æ€ç 

## ğŸ”® æ‰©å±•æ–¹å‘

è¯¥æ¨¡å—ä¸ºåç»­çš„è¯„è®ºçˆ¬è™«å’Œå¤„ç†åŠŸèƒ½æ‰“ä¸‹äº†åŸºç¡€ï¼Œå¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•ï¼š

1. **è¯„è®ºçˆ¬è™«**: å®é™…ä»å„æ¸ é“çˆ¬å–è¯„è®ºæ•°æ®
2. **è¯„è®ºæ›´æ–°**: å¢é‡æ›´æ–°è¯„è®ºæ•°æ®
3. **è¯„è®ºåˆ†æ**: å¯¹è¯„è®ºå†…å®¹è¿›è¡Œæƒ…æ„Ÿåˆ†æå’Œç‰¹å¾æå–
4. **è¯„è®ºè¿‡æ»¤**: æ ¹æ®æ¡ä»¶ç­›é€‰å’Œåˆ†é¡µæ˜¾ç¤ºè¯„è®º 